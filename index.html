<!doctype html>
<!-- prosodylab-jspsych-helper Michael Wagner chael@mcgill.ca-->

<html>
  
  <head>
    <title>prosodylab</title>
    <!--general-->
    <script src="papaparse.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="http://cdn.jsdelivr.net/npm/showdown@1.9.0/dist/showdown.min.js"></script>
    
    <!-- country/region select -->
    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="node_modules/country-region-dropdown-menu/assets/js/geodatasource-cr.min.js"></script>
    <link rel="stylesheet" href="node_modules/country-region-dropdown-menu/assets/css/geodatasource-countryflag.css"/>
    <link rel="gettext" type="application/x-po" href="node_modules/country-region-dropdown-menu/languages/en/LC_MESSAGES/en.po" />
    <script type="text/javascript" src="node_modules/country-region-dropdown-menu/assets/js/Gettext.js"></script>
     
    
    <!-- jspsych -->
    <script src="jspsych-6.1.0/jspsych.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-call-function.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-fullscreen.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-slider-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-image-keyboard-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-button-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-audio-button-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-audio-keyboard-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-instructions.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-survey-text.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-survey-likert.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-slider-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-survey-html-form"></script>
    <!--  <script src="jsPsych.randomization"></script> -->

    <!-- prosodylab -->
    <script src="prosodylab/prosodylab-helper.js"></script>
    
    <!-- css -->
    <link href="jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css"></link>
  </head>
  
  <body></body>

  <script>

// ---- switches ----

// display data at the end for testing
var displayData = 1;
var fullScreen  = 0;

// ----- experiment specific information ----

  var pathMaterials = 'experiment'; // needs to have audio/img if applicable

  var materials = {
        stimuliFile: `${pathMaterials}/rhymeShortest.txt`,
        soundCheckFile: `${pathMaterials}/audio/da_equal.mp3`,
        helloFile: `${pathMaterials}/hello.md`,
        consentFile: `${pathMaterials}/consent.md`,
        goodbyeFile: `${pathMaterials}/goodbye.md`
        };

  // unique particpiant code (used also as completion code for mturk)
  var participantCode = jsPsych.randomization.randomID(6);
  // use random code for data file name
  var dataFilename = `data_${participantCode}`;


  //  ----- load files ----

  // load experiment file
  materials.stimuli = prosodylab.loadCSV(materials.stimuliFile);
  // loadwelcome txt
  materials.hello=prosodylab.loadMD(materials.helloFile);
  // load  consent txt
  materials.consent=prosodylab.loadMD(materials.consentFile);
  // load goodbye text
  materials.goodbye = prosodylab.loadMD(materials.goodbyeFile);

  //  ---- set-up  ----

  var timeline = [];
  var timeline_variables = [];


  //  ---- pre experiment  ----
  
   prosodylab.screen('hello',materials.hello,'Click here to continue',participantCode);
  
  //  ---- consent page  ----
  
  // The last paragraph of the consent  form will be the  consent button
  // and will  be stored with the participant's data:
  prosodylab.consent(materials.consent, participantCode);
  
  //// Use this code instead if you do not want to use the last paragraph as button
  //prosodylab.screen('Consent',materials.consent,'I consent',${participantCode},'justify');

  // ---- language questionnaire ---

  prosodylab.languageQuestionnaire(participantCode);
  
  // ---- sound check
  
  prosodylab.soundCheck(materials.soundCheckFile,participantCode);
  

  //  ---- build experiment  ----
  
  if (fullScreen) {
    timeline.push({
      type: 'fullscreen',
      message: `<p> <b>All set!</b> <br><br> <em>Please click the button below
       to enter full screen mode and start with the experiment</em></p>`,
      fullscreen_mode: true,
      data: {
       component: 'full screen',
       participant: participantCode
      }
    });
  }
  
  var session = [];
  var experimentN = [];
  var sessionStimuli = [];
  var sessionExperiments = [];
  var maxLength = 0;
  var playList = [];
  var instructions = [];
  var instructionsFile = [];
  
  if (!materials.stimuli.session) {
    materials.stimuli.session = 1
  }
  
  sessions = Math.max(...materials.stimuli.map(value => value.session));
  trialInfo = [];

  // cycle through sessions and add trials
  for (iSession=0; iSession<sessions;iSession++) {
  
    console.log('Session:',iSession+1,'of',sessions);
  
    // reset variables for session
    session = [];
    experimentN = [];
    sessionStimuli = [];
    sessionExperiments = [];
    maxLength = 0;
    playList = [];
    instructions = [];
    
    // Subset of stimuli for this session
    sessionStimuli = materials.stimuli.filter(obj => obj.session == (iSession+1));
    sessionExperiments = [...new Set(sessionStimuli.map(value => value.experiment))];
    experimentN = sessionExperiments.length;

    
    // load and display session instructions
    console.log('SessionStimuli',sessionStimuli);
    
    if (!sessionStimuli[0].instructions){// default name for instructions file
      instructionsFile='instructions.md'
    } else {
      instructionsFile = [...new Set(sessionStimuli.map(value => value.instructions))];
    }
    
    if (instructionsFile.length==1) {
        instructions = prosodylab.loadMD(`${pathMaterials}/${instructionsFile}`);
    } else {
        instructions = `There has to be a unique instructions file per session. 
           Session: ${iSession+1} has instructions: ${instructionsFile.toString()}`
        console.error(instructionsFile);
    }
    
    prosodylab.screen('Instructions',instructions, 'Click here to start the experiment',participantCode,'center');

    var experimentStimuli=[];
        
    // separate out stimuli for each experiment in this session
    for (j=0;j<experimentN;j++) {
    
       // subset of stimuli of this experiment
       playList[j] = sessionStimuli.filter(obj => obj.experiment == sessionExperiments[j]);
             
       // generate playlist for this experiment:
       playList[j] = prosodylab.generatePlaylist(playList[j]);
       
       // keep track of how long longest experiment is
       maxLength = Math.max(maxLength,playList[j].length);
       // show information about experiment in console:
       console.log('experiment:',sessionExperiments[j],
           'length: ',playList[j].length,'design: ',
           [...new Set(sessionStimuli.map(value => value.design))]);
    }
    
    // add trials for experiment, interspersing them
    sessionTrial = 0;
    for (j=0;j<maxLength;j++){
        for (k=0;k<experimentN;k++){
          // if end of experiment has not been reached, add trial
                    
          if ((j+1)<=playList[k].length) {
            sessionTrial++;
            trialInfo = {
              participant: participantCode,
              component: 'Experiment',
              session: iSession+1,
              experiment: sessionExperiments[k],
              item: playList[k][j].item,
              condition: playList[k][j].condition,
              sessionTrial: sessionTrial,
              experimentTrial: j+1,
            };
            session = prosodylab.addTrial(session,playList[k][j],trialInfo);
          }
        }
    }
    
    timeline = [...timeline, ...session];
    
  }

  // ---- debriefing ---
  
  prosodylab.debriefing(participantCode);

  
  // ---- music questionnaire ---
  
  prosodylab.musicQuestionnaire('MusicianShip',participantCode);
  
  
  //save Data function that calls php script
  function saveData(name, data){
      var xhr = new XMLHttpRequest();
      xhr.open('POST', 'write_data.php');
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.send(JSON.stringify({filename: name, filedata: data}));
  }


  timeline.push({ 
    type: 'call-function',
    func: function(data){
        saveData(`data/${dataFilename}.json`, jsPsych.data.get().json());
    }
  });


  
  if (fullScreen) {
    timeline.push({
      type: 'fullscreen',
      fullscreen_mode: false
    });
  }
  
  
  // ---- goodbye ----
  
  prosodylab.screen('Goodbye',materials.goodbye,'Click to leave experiment',participantCode,'center');

  
  //  ---- data processing  ----

  // call the saveData function after the experiment is over

  jsPsych.init({
      timeline: timeline,
      //on_close:  function(){
      //  saveData(`data/onclose_${dataFilename}.csv`, jsPsych.data.get().csv());
      //  saveData(`data/onclose_${dataFilename}.json`, jsPsych.data.get().json());
      //},
      on_finish: function(){
        if (displayData) {jsPsych.data.displayData();}
      }
  })

  </script>
</html>
