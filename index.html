<!doctype html>
<!-- prosodylab-jspsych-experimenter Michael Wagner chael@mcgill.ca-->

<!--todo:
experiment of a certain name cant have more than one session, script should check that! (
otherwise, recordings will get overwritten)

path from study.path to data/recordedFiles is hardcoded right now, desirable?
-->

<html>
  
  <head>
    <title>prosodylab</title>
    
    <!--general-->
    <meta charset="utf-8">
        
    <script src="javascripts/papaparse.min.js"></script>
    <script src="javascripts/jquery.min.js"></script>
    <script src="javascripts/showdown.min.js"></script>
    
    <!-- country/region select -->
    <script src="javascripts/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="javascripts/jquery-ui.css">
    <script src="javascripts/node_modules/country-region-dropdown-menu/assets/js/geodatasource-cr.min.js"></script>
    <link rel="stylesheet" href="javascripts/node_modules/country-region-dropdown-menu/assets/css/geodatasource-countryflag.css"/>
    <link rel="gettext" type="application/x-po" href="javascripts/node_modules/country-region-dropdown-menu/languages/en/LC_MESSAGES/en.po" />
    <!-- Japanese country options -->
    <link rel="gettext" type="application/x-po" href="javascripts/node_modules/country-region-dropdown-menu/languages/ja/LC_MESSAGES/ja.po" />
    <script type="text/javascript" src="javascripts/node_modules/country-region-dropdown-menu/assets/js/Gettext.js"></script>
     
    
    <!-- jspsych -->
    <script src="javascripts/jspsych-6.1.0/jspsych.js"></script>
    <script src="javascripts/jspsych-6.1.0/plugins/jspsych-call-function.js"></script>
    <script src="javascripts/jspsych-6.1.0/plugins/jspsych-fullscreen.js"></script>
    <script src="javascripts/jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="javascripts/jspsych-6.1.0/plugins/jspsych-html-slider-response.js"></script>
    <script src="javascripts/jspsych-6.1.0/plugins/jspsych-image-keyboard-response.js"></script>
    <script src="javascripts/jspsych-6.1.0/plugins/jspsych-html-button-response.js"></script>
    <script src="javascripts/jspsych-6.1.0/plugins/jspsych-audio-button-response.js"></script>
    <script src="javascripts/jspsych-6.1.0/plugins/jspsych-audio-keyboard-response.js"></script>
    <script src="javascripts/jspsych-6.1.0/plugins/jspsych-instructions.js"></script>
    <script src="javascripts/jspsych-6.1.0/plugins/jspsych-survey-text.js"></script>
    <script src="javascripts/jspsych-6.1.0/plugins/jspsych-survey-likert.js"></script>
    <script src="javascripts/jspsych-6.1.0/plugins/jspsych-html-slider-response.js"></script>
    <script src="javascripts/jspsych-6.1.0/plugins/jspsych-survey-html-form.js"></script>

    <!-- prosodylab -->
    <script src="prosodylab/prosodylab-helper.js"></script>
    
    <!-- css -->
    <link href="javascripts/jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css"></link>
  </head>
  
  <body></body>

  <script>


// ---- settings ----


let study = {path: 'examples/experimentListenAndRate'}; // needs to have audio/images subdirectories if applicable
  
study = {...study, 
  logFile: `${study.path}/studyLog.json`,
  stimuliFile: `${study.path}/rhymeShortest.txt`,
  soundCheckFile: `prosodylab/soundcheck_da.mp3`,//`${study.path}/audio/soundcheck_da.mp3`,
  helloFile: `${study.path}/hello.md`,
  consentFile: `${study.path}/consent_production_prolific.md`,
  goodbyeFile: `${study.path}/goodbye.md`
 };
 
 // contact Email in case of problem with urlparameter transmission of participant info
const contactEmail = ''

// completion code and completionLink are used, for example for prolific studies
const completionLink = "";
const completionCode = ""; // not necessary unless it will be displayed at the end

const experimentLanguage = 'en' // set which language interaction will be in
const messages  = prosodylab.getMessages(experimentLanguage); // load messages
const displayDataAfterFinish = true; // shows collected data in json format after
const showProgressBar = true; // shows progress to participant during study
const fullScreen  = false; // doesn't work with IE, but will simply proceed anyway 
const doExperimentOnly  = true; // excludes pre-  and post-experiment parts
let pListMethod = 'log'   /* Some designs (Blocked, Between, LatinSquare, Within) 
       assign different types of playlists to different participants. 
       --  'log' = use log to count which playlist has been run least
       --  'random' (assigns pList randomly)
       -- or set an integer (like '1') to hardcode the pList here*/

const participantCodeMethod = 'randomAndDisplay'; /* alternative methods to determine participant ID. Options: 
    * SESSION_ID  // default for prolific prosodylab, more confidential than PID
    * PROLIFIC_PID
    * random 
    * randomAndDisplay // default in prosody for amazon*/
    // PROLIFIC_SESSION_ID and PROLIFIC_PID requires passing urlparams from prolific

// this should be replaced by adding all study parameters at beginning of results file:
jsPsych.data.addProperties({stimuliFile: study.stimuliFile});



// Get urlParams if there are any
let urlParams = prosodylab.getURLParameters();

let participantCode = prosodylab.assignParticipantcode(participantCodeMethod,urlParams)

//  ---- set-up timeline for experiment ----

let timeline = [];
if (!participantCode) {
  // urlParams weren't properly transmitted, throw error to participant
  timeline.push(prosodylab.screen(`<em>Something didn't work! Contact: ${contactEmail}
      </em>`,'noSessionIdError','Click here to leave experiment','center'));
  } else {
  
  // use participantCode for name of results file
  const dataFilename = `data_${participantCode}`;

  // load spreadsheet with all experiments, global variable
  stimuli = prosodylab.loadCSV(study.stimuliFile);
  // save variable names of study spreadsheet 
  let variables = Object.keys(stimuli[0]);
  
  // load study log if there is one
  // otherwise an empty log will be written to data folder]

  let studyLog = prosodylab.loadLog(study.logFile);
  
  
  // check for audio recording consent if necessary
  recordVariables = ['record','listenRepeatRecord','plannedProduction'];
  
  if (recordVariables.some(r=> variables.includes(r))) {
     var blob;
     var audio_chunk;
     var rec = [];
     var soundFileName;
     prosodylab.getAudioConsent();
  } 
  
  //  ---- hello page ----
  
  if (!doExperimentOnly){
    timeline.push(prosodylab.screenFromMD(study.helloFile,'hello','left'));
  }
  
  // ---- full screen mode if applicable --
  
  if (fullScreen) {
    timeline.push(prosodylab.fullScreenOn());
  }
  
  //  ---- consent page  ----
  
  // The last paragraph of the consent  form will be the  consent button
  // and will  be stored with the participant's data:
  if (!doExperimentOnly){
     timeline.push(prosodylab.screenFromMD(study.consentFile,'consent','left'));
  }
  
  // ---- language questionnaire ---

  if (!doExperimentOnly){
   timeline.push(prosodylab.languageQuestionnaire(experimentLanguage));
  }
  
  // ---- sound check (if audio is involved)
  
  if (!doExperimentOnly){
    timeline = [...timeline, ...prosodylab.soundCheck(study.soundCheckFile)];
  }
  
  // ---- head phone screener ----
  
  if (!doExperimentOnly){
     timeline = [...timeline, ...prosodylab.headPhoneScreener()];
  }
  
  //  
  //  ---- build sessions of experiment trials and add to timeline  ----
  //
 
  console.log('participantCode',participantCode);
  experiment = prosodylab.createSessions(stimuli,studyLog,participantCode);
  
  timeline = [...timeline, ...experiment.timeline];
  

  // Post Experiment 
  
  // ---- debriefing ---
  
  if (!doExperimentOnly){
    timeline.push(prosodylab.debriefing(experimentLanguage));
  }
  // ---- music questionnaire ---
  
  if (!doExperimentOnly){
    //timeline.push(prosodylab.musicQuestionnaire('MusicianShip'));
  }
  
  // ----  save data ----
  
  // choose 'csv' as second argument if you want to save  as .csv instead  of json
  timeline.push(prosodylab.saveData(`${study.path}/data/${dataFilename}`,'json'));
  timeline.push(prosodylab.appendJsonCallFunction(experiment.newStudyLogEntries,study.logFile));  
   // exit full screen
  
  if (fullScreen) {
    timeline.push({
      type: 'fullscreen',
      fullscreen_mode: false
    });
  }
  
  // ---- goodbye screen (with completion code if applicable )----
  
  if (!doExperimentOnly){
    if (participantCodeMethod == 'randomAndDisplay') {
      timeline.push(prosodylab.screenFromMD(study.goodbyeFile,'goodBye','center',participantCode));
    } else if (completionCode) { 
      //timeline.push(prosodylab.screenFromMD(study.goodbyeFile,'goodBye','center',completionCode));
    } else {
      //timeline.push(prosodylab.screenFromMD(study.goodbyeFile,'goodBye','center'));
    }
  }
  
  
  } 
  
  //  ---- general settings  ----

  jsPsych.init({
      timeline: timeline,
      //// uncomment to save data on close (but closing the tab could mean wihdrawn consent!)
      //on_close:  function(){
      //  prosodylab.saveData(`${study.path}/data/${dataFilename}.json, jsPsych.data.get().json());
      //  prosodylab.saveData(`${study.path}/data/${dataFilename}.csv, jsPsych.data.get().csv());
      //},
      show_progress_bar: showProgressBar,
      on_finish: function(){
        if (displayDataAfterFinish) {
           // output full data to tab
           jsPsych.data.displayData();
        }
        if (completionLink&&participantCode) {
          if (completionLink.length>0){
            location.href=completionLink
          }
        }
      }
  })

  </script>
</html>
