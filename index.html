<!doctype html>
<!-- prosodylab.jsexperimenter chael@mcgill.ca-->

<html>
  
  <head>
    <title>prosodylab</title>
    <!--general-->
    <script src="papaparse.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="http://cdn.jsdelivr.net/npm/showdown@1.9.0/dist/showdown.min.js"></script>
    
    <!-- country/region select -->
    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="node_modules/country-region-dropdown-menu/assets/js/geodatasource-cr.min.js"></script>
    <link rel="stylesheet" href="node_modules/country-region-dropdown-menu/assets/css/geodatasource-countryflag.css"/>
    <link rel="gettext" type="application/x-po" href="node_modules/country-region-dropdown-menu/languages/en/LC_MESSAGES/en.po" />
    <script type="text/javascript" src="node_modules/country-region-dropdown-menu/assets/js/Gettext.js"></script>
    
    <!-- other country seelction 
    <script type="text/javascript" src="country-regions-country-region-selector-619110c/dist/crs.min.js"
    window.onload = function()
      {
          init();
      };
    ></script>
    -->
    
    <!-- jspsych -->
    <script src="jspsych-6.1.0/jspsych.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-slider-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-image-keyboard-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-html-button-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-audio-button-response.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-instructions.js"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-survey-text"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-survey-likert"></script>
    <script src="jspsych-6.1.0/plugins/jspsych-survey-html-form"></script>
    <!--  <script src="jsPsych.randomization"></script> -->

    <!-- prosodylab -->
    <script src="prosodylab/prosodylab-helper.js"></script>
    <script src="prosodylab/musicQuestionnaire.js"></script>
    
    <!-- css -->
    <link href="jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css"></link>
  </head>
  
  <body></body>

  <script>

// ---- switches ----

// display data at the end for testing
var displayData = 1;


// ----- experiment specific information ----


  var pathMaterials = 'materials/';

  var materials = {
        soundCheckFile: pathMaterials + 'audio/da_equal.wav',
        stimuliFile: pathMaterials + 'noncitl.txt',
        helloFile: pathMaterials +'hello.md',
        consentFile: pathMaterials + 'consent_audio.md',
        instructionsFile: pathMaterials + 'instructions.md',
        goodbyeFile: pathMaterials + 'goodbye.md'
        };


  // unique particpiant code (used also as completion code for mturk)
  var participantCode = jsPsych.randomization.randomID(6);
  // use random code for data file name
  var dataFilename = 'data_'+ participantCode;


  //  ----- load files ----

  // load experiment file
  materials.stimuli = prosodylab.loadCSV(materials.stimuliFile);
  // loadwelcome txt
  materials.hello=prosodylab.loadMD(materials.helloFile);
  // load  consent txt
  materials.consent=prosodylab.loadMD(materials.consentFile);
  // load instructions
  materials.instructions = prosodylab.loadMD(materials.instructionsFile);
  // load goodbye text
  materials.goodbye = prosodylab.loadMD(materials.goodbyeFile);


  //  ---- set-up  ----

  var timeline = [];
  var timeline_variables = [];

  //  ---- pre experiment  ----
  
  prosodylab.screen('hello',materials.hello,'Click here to continue');
  
  //  ---- consent page  ----
  
  prosodylab.screen('consent',materials.consent,'I consent');

  // ---- language questionnaire ---

  prosodylab.languageQuestionnaire();
  
  // ---- sound check
  
  prosodylab.soundCheck(materials.soundCheckFile);
  
  // ---- instructions ----
  
  prosodylab.screen('instructions',materials.instructions,
                        'Click here to start the experiment','center');

  //  ---- build experiment  ----
  
  var playList = [];
  
  if (!materials.stimuli.data.session) {var sessions = 1}
  
  for (i=0; i<sessions;i++) {
  
    session = [];
    playList = prosodylab.generatePlaylist(materials.stimuli.data);
  
    for (i=0;i<playList.length;i++) {
      session = prosodylab.addTrial(session,playList[i]);
    }
  
    timeline = [...timeline, ...session];
    
    console.log('length:',playList.length,'timeline',timeline);
  }


  // ---- debriefing ---
  
  prosodylab.debriefing();

  
  // ---- music questionnaire ---
  
  musicQuestionnaire();
  
  // ---- goodbye ----
  
  prosodylab.screen('goodbye',materials.goodbye,'Click to send data','center',participantCode);
  
  //  ---- data processing  ----


  //Save Data
  function saveData(name, data){
      var xhr = new XMLHttpRequest();
      xhr.open('POST', 'write_data.php');
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.send(JSON.stringify({filename: name, filedata: data}));
      }

  // call the saveData function after the experiment is over

  jsPsych.init({
      timeline: timeline,
      on_finish: function(){
                  saveData(dataFilename, jsPsych.data.get().csv());
                  if (displayData) {jsPsych.data.displayData();}
                 }, 
  })

  </script>
</html>
