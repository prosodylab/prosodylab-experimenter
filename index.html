<!doctype html>
<!-- prosodylab-jspsych-helper Michael Wagner chael@mcgill.ca-->

<html>
  
  <head>
    <title>prosodylab</title>
    <!--general-->
    <script src="javascripts/papaparse.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="http://cdn.jsdelivr.net/npm/showdown@1.9.0/dist/showdown.min.js"></script>
    
    <!-- country/region select -->
    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="javascripts/node_modules/country-region-dropdown-menu/assets/js/geodatasource-cr.min.js"></script>
    <link rel="stylesheet" href="javascripts/node_modules/country-region-dropdown-menu/assets/css/geodatasource-countryflag.css"/>
    <link rel="gettext" type="application/x-po" href="javascripts/node_modules/country-region-dropdown-menu/languages/en/LC_MESSAGES/en.po" />
    <script type="text/javascript" src="javascripts/node_modules/country-region-dropdown-menu/assets/js/Gettext.js"></script>
     
    
    <!-- jspsych -->
    <script src="javascripts/jspsych-6.1.0/jspsych.js"></script>
    <script src="javascripts/jspsych-6.1.0/plugins/jspsych-call-function.js"></script>
    <script src="javascripts/jspsych-6.1.0/plugins/jspsych-fullscreen.js"></script>
    <script src="javascripts/jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="javascripts/jspsych-6.1.0/plugins/jspsych-html-slider-response.js"></script>
    <script src="javascripts/jspsych-6.1.0/plugins/jspsych-image-keyboard-response.js"></script>
    <script src="javascripts/jspsych-6.1.0/plugins/jspsych-html-button-response.js"></script>
    <script src="javascripts/jspsych-6.1.0/plugins/jspsych-audio-button-response.js"></script>
    <script src="javascripts/jspsych-6.1.0/plugins/jspsych-audio-keyboard-response.js"></script>
    <script src="javascripts/jspsych-6.1.0/plugins/jspsych-instructions.js"></script>
    <script src="javascripts/jspsych-6.1.0/plugins/jspsych-survey-text.js"></script>
    <script src="javascripts/jspsych-6.1.0/plugins/jspsych-survey-likert.js"></script>
    <script src="javascripts/jspsych-6.1.0/plugins/jspsych-html-slider-response.js"></script>
    <script src="javascripts/jspsych-6.1.0/plugins/jspsych-survey-html-form.js"></script>

    <!-- prosodylab -->
    <script src="prosodylab/prosodylab-helper.js"></script>
    
    <!-- css -->
    <link href="javascripts/jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css"></link>
  </head>
  
  <body></body>

  <script>

// ---- switches ----


//  some options can be set  here:
const displayDataAfterFinish = true; // shows collected data in json format after
const showProgressBar = true; // shows progress to participant during study
const fullScreen  = false; // doesn't work with IE, but will simply proceed anyway 
const doExperimentOnly  = true; // excludes pre-  and post-experiment parts


// Some designs (Blocked, Between, LatinSquare, Within) assign a particular playlists to a participant
const pListMethod = 'log' /* can be 'log' = playlist is assigned based on the log file of who was
      assigned which playlist before, or 'random', which will assign it randomly */


// ----- experiment specific information ----


  let experiment = {path: 'experiment'}; // needs to have audio/img subdirectories if applicable
  
  experiment = {...experiment, 
    studyLogFile: `${experiment.path}/data/log.json`,
    stimuliFile: `${experiment.path}/rhymeShortest.txt`,
    soundCheckFile: `${experiment.path}/audio/da_equal.mp3`,
    helloFile: `${experiment.path}/hello.md`,
    consentFile: `${experiment.path}/consent.md`,
    goodbyeFile: `${experiment.path}/goodbye.md`
  };


  // unique particpiant code (used also as completion code for mturk)
  const participantCode = jsPsych.randomization.randomID(6);
  // use random code for data file name
  const dataFilename = `data_${participantCode}`;

  jsPsych.data.addProperties({
    participant: participantCode,
    stimuliFile: experiment.stimuliFile
  });

  //  ----- load experiment files ----

  // load spreadsheet with all experiments
  experiment.stimuli = prosodylab.loadCSV(experiment.stimuliFile);
  // load welcome txt
  experiment.hello=prosodylab.loadMD(experiment.helloFile);
  // load consent text
  experiment.consent=prosodylab.loadMD(experiment.consentFile);
  // load goodbye text
  experiment.goodbye = prosodylab.loadMD(experiment.goodbyeFile);


  //  ---- set-up timeline for experiment ----

  let timeline = [];
  let timeline_variables = [];

  //  ---- pre experiment ----
  
  if (!doExperimentOnly){
    prosodylab.screen('Hello',experiment.hello,'Click here to continue');
  }
  
  //  ---- consent page  ----
  
  // The last paragraph of the consent  form will be the  consent button
  // and will  be stored with the participant's data:
  
  if (!doExperimentOnly){
     prosodylab.consent(experiment.consent);
  }
  
  //// Use this code instead if you do not want to use the last paragraph as button
  //prosodylab.screen('Consent',experiment.consent,'I consent',participantCode,'justify');

  // ---- language questionnaire ---

  if (!doExperimentOnly){
   // prosodylab.languageQuestionnaire();
  }
  
  // ---- sound check (if audio is involved)
  
  if (!doExperimentOnly){
    prosodylab.soundCheck(experiment.soundCheckFile);
  }
  
  // ---- head phone screener ----
  
  if (!doExperimentOnly){
     timeline = [...timeline, ...prosodylab.headPhoneScreener()];
  }
  //  ---- build experiment  ----
  
  if (fullScreen) {
    timeline.push({
      type: 'fullscreen',
      message: `<p> <b>All set!</b> <br><br> <em>Please click the button below
       to enter full screen mode and start with the experiment</em></p>`,
      fullscreen_mode: true,
      data: {
       component: 'full screen',
       participant: participantCode
      }
    });
  }
  
  
  let session = [];
  let experimentN = [];
  let sessionStimuli = [];
  let sessionExperiments = [];
  let maxLength = 0;
  let playList = [];
  let instructions = [];
  let instructionsFile = [];
  let trial = [];
  let trialInfo = [];
  let pList = [];
  let sessionTrial = [];
  let newStudyLogEntries = [];
  let conditions  = [];
  
   // read  prior participant log if there is one
   // otherwise an empty log will be written to data folder]
  let studyLog = prosodylab.loadLog(experiment.studyLogFile);
  
  // 
  // for  given experiment, get subset of entries for that expermient from log  with .filter
  //    smilar to:  experiment.stimuli.filter(obj => obj.session == (iSession+1));
  // then list of  all values for a pList  key: 
  //      somethnig  similar to: var nameArray = students.map(function (el) { return el.name; });
  // the count occurrences of each value, as well as pList yet not played...
  // based on this, assign new pList
  
  // cycle through sessions and add trials
  
  
  // xx this won't work---needs to be added as key to all objects!
  if (!experiment.stimuli.session) {
    experiment.stimuli.session = 1
  }
  
  sessions = Math.max(...experiment.stimuli.map(value => value.session));
  
  for (let iSession=0; iSession<sessions;iSession++) {
    
    // reset variables for session
    session = [];
    experimentN = [];
    sessionStimuli = [];
    sessionExperiments = [];
    maxLength = 0;
    playList = [];
    pList = [];
    instructions = [];
    sessionTrial = 0;

    
    // Subset of stimuli for this session
    sessionStimuli = experiment.stimuli.filter(obj => obj.session == (iSession+1));
    sessionExperiments = [...new Set(sessionStimuli.map(value => value.experiment))];
    experimentN = sessionExperiments.length;

    
    // load and display session instructions    
    if (!sessionStimuli[0].instructions){// default name for instructions file
      instructionsFile='instructions.md'
    } else {
      instructionsFile = [...new Set(sessionStimuli.map(value => value.instructions))];
    }
    
    if (instructionsFile.length==1) {
        instructions = prosodylab.loadMD(`${experiment.path}/${instructionsFile}`);
    } else {
        instructions = `There has to be a unique instructions file per session. 
           Session: ${iSession+1} has instructions: ${instructionsFile.toString()}`
        console.error(instructionsFile);
    }
    
    prosodylab.screen('Instructions',instructions, 'Click here to start the experiment','center');

    let experimentStimuli=[];
    //let conditions = [];
        
    // separate out stimuli for each experiment in the current session
    for (let j=0;j<experimentN;j++) {
    
       // subset of all stimuli of this experiment
       playList[j] = sessionStimuli.filter(obj => obj.experiment == sessionExperiments[j]);
       
       // if pListMethod is set to random or studyLog is empty, assign plist randomly
       if (pListMethod =='random' || !Object.keys(studyLog).length) {
         log = 0;
       } else {log = studyLog}
       
       // select conditions and generate ordered playlist of stimuli for this experiment
       // condition selection/ordering will depend on pList for certain designs
       // pList will either be assigned based on log or randomly
       playList[j] = prosodylab.generatePlaylist(playList[j],log);
       
       // keep track of how long longest experiment is
       maxLength = Math.max(maxLength,playList[j].length);
       // show information about experiment in console:
       console.log('experiment:',sessionExperiments[j],
           'length: ',playList[j].length,'design: ',
           [...new Set(playList[j].map(value => value.design))],'playList',playList[j]);
           
       newStudyLogEntries.push({
         experiment: sessionExperiments[j], 
         pList: [...new Set(playList[j].map(value => value.pList))][0]
       }); 
    }
    
    // add participant information to newStudyLogEntries
    newStudyLogEntries.map(v => ({...v, participant: participantCode}));  
    console.log('newStudyLogEntries',newStudyLogEntries);
    
    // add trials for experiment, interspersing them
    sessionTrial = 0;
    for (let j=0;j<maxLength;j++){
        for (let k=0;k<experimentN;k++){
          // if end of experiment has not been reached, add trial
                    
          if ((j+1)<=playList[k].length) {
            sessionTrial++;
            trial = playList[k][j];
            
            trialInfo = {
              component: 'Experiment',
              session: iSession+1,
              experiment: sessionExperiments[k],
              item: trial.item,
              condition: trial.condition,
              sessionTrial: sessionTrial,
              experimentTrial: j+1,
            };
            // add playlist assignment for designs  where it matters
            if (trial.pList!=0) {
              trialInfo.pList = trial.pList;
            }
            
            trial.path = experiment.path;
            session = prosodylab.addTrial(session,playList[k][j],trialInfo);
          }
        }
    }
    
    console.log('Session',iSession+1,'of',sessions,': ',sessionTrial,'trials');
    timeline = [...timeline, ...session];
    
  }

  // Post Experiment 
  
  // ---- debriefing ---
  
  if (!doExperimentOnly){
    prosodylab.debriefing();
  }
  // ---- music questionnaire ---
  
  if (!doExperimentOnly){
    //prosodylab.musicQuestionnaire('MusicianShip');
  }
  
  // ----  save data ----
  
  // choose 'csv' as second argument if you want to save  as .csv instead  of json
  timeline.push(prosodylab.saveData(`${experiment.path}/data/${dataFilename}`,'json'));

  timeline.push(prosodylab.appendJson(newStudyLogEntries,experiment.studyLogFile));
  

  // saving log not implemented yet
  //timeline.push(prosodylab.saveStudyLog(`${experiment.path}/data/studylog.json`));

   // exit full screen
  
  if (fullScreen) {
    timeline.push({
      type: 'fullscreen',
      fullscreen_mode: false
    });
  }
  
  // ---- goodbye screen (with completion code if applicable )----
  
  if (!doExperimentOnly){
    prosodylab.screen('Goodbye',experiment.goodbye,`I've noted down the participant 
    code and want to  leave the experiment now.`,'center',participantCode);
  }
  
  //  ---- general settings  ----

  jsPsych.init({
      timeline: timeline,
      //// uncomment to save data on close (but closing the tab could mean wihdrawn consent!)
      //on_close:  function(){
      //  prosodylab.saveData(`${experiment.path}/data/${dataFilename}.json, jsPsych.data.get().json());
      //  prosodylab.saveData(`${experiment.path}/data/${dataFilename}.csv, jsPsych.data.get().csv());
      //},
      show_progress_bar: showProgressBar,
      on_finish: function(){
        if (displayDataAfterFinish) {
           // output full data to tab
           jsPsych.data.displayData();
           
           // output results for question1 to console
           // var experimentData = jsPsych.data.get().filter({ trialPart: "question1"});
           // console.log('experimentData.csv',experimentData.csv());
           
           
           }
      }
  })

  </script>
</html>
