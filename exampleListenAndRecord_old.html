<!doctype html>
<!-- prosodylab-jspsych-experimenter Michael Wagner chael@mcgill.ca-->

<!--todo:
experiment of a certain name cant have more than one session, script should check that! (
otherwise, recordings will get overwritten)

path from study.path to data/recordedFiles is hardcoded right now, desirable?
-->

<html>
  
  <head>
    <title>prosodylab</title>
    
    <!--general-->
    <meta charset="utf-8">
        
    <script src="javascripts/papaparse.min.js"></script>
    <script src="javascripts/jquery.min.js"></script>
    <script src="javascripts/showdown.min.js"></script>
    
    <!-- country/region select -->
    <script src="javascripts/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="javascripts/jquery-ui.css">
    <script src="javascripts/node_modules/country-region-dropdown-menu/assets/js/geodatasource-cr.min.js"></script>
    <link rel="stylesheet" href="javascripts/node_modules/country-region-dropdown-menu/assets/css/geodatasource-countryflag.css"/>
    <link rel="gettext" type="application/x-po" href="javascripts/node_modules/country-region-dropdown-menu/languages/en/LC_MESSAGES/en.po" />
    <!-- Japanese country options -->
    <link rel="gettext" type="application/x-po" href="javascripts/node_modules/country-region-dropdown-menu/languages/ja/LC_MESSAGES/ja.po" />
    <script type="text/javascript" src="javascripts/node_modules/country-region-dropdown-menu/assets/js/Gettext.js"></script>
     
    
    <!-- jspsych -->
    <script src="javascripts/jspsych-6.1.0/jspsych.js"></script>
    <script src="javascripts/jspsych-6.1.0/plugins/jspsych-call-function.js"></script>
    <script src="javascripts/jspsych-6.1.0/plugins/jspsych-fullscreen.js"></script>
    <script src="javascripts/jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="javascripts/jspsych-6.1.0/plugins/jspsych-html-slider-response.js"></script>
    <script src="javascripts/jspsych-6.1.0/plugins/jspsych-image-keyboard-response.js"></script>
    <script src="javascripts/jspsych-6.1.0/plugins/jspsych-html-button-response.js"></script>
    <script src="javascripts/jspsych-6.1.0/plugins/jspsych-audio-button-response.js"></script>
    <script src="javascripts/jspsych-6.1.0/plugins/jspsych-audio-keyboard-response.js"></script>
    <script src="javascripts/jspsych-6.1.0/plugins/jspsych-instructions.js"></script>
    <script src="javascripts/jspsych-6.1.0/plugins/jspsych-survey-text.js"></script>
    <script src="javascripts/jspsych-6.1.0/plugins/jspsych-survey-likert.js"></script>
    <script src="javascripts/jspsych-6.1.0/plugins/jspsych-html-slider-response.js"></script>
    <script src="javascripts/jspsych-6.1.0/plugins/jspsych-survey-html-form.js"></script>

    <!-- prosodylab -->
    <script src="prosodylab/prosodylab-helper.js"></script>
    
    <!-- css -->
    <link href="javascripts/jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css"></link>
  </head>
  
  <body></body>

  <script>


// ---- settings ----


let study = {path: 'examples/listenAndRecord'}; // needs to have audio/images subdirectories if applicable
  
study = {...study, 
  //
  language: 'en', // set which language interaction will be in
  // relevant files
  // files you need to provide:
  stimuliFile: `${study.path}/arithListenRecord.txt`, // your experiment stimuli
  helloFile: `${study.path}/hello.md`,
  consentFile: `${study.path}/consent.md`,
  goodbyeFile: `${study.path}/goodbye.md`,
  //
  logFile: `${study.path}/studyLog.json`, // this is where log will be saved
  soundCheckFile: `prosodylab/soundcheck_da.mp3`,// file played for soundcheck
  // 
  // completion code and completionLink are used, 
  completionLink: "", // link to send participant after end, e.g. for Prolific studies
  completionCode: "", // not necessary unless it will be displayed at the end
  //
  pListMethod: 'log',/* Some designs (Blocked, Between, LatinSquare, Within) 
       assign different types of playlists to different participants. 
       --  'log' = use log to count which playlist has been run least
       --  'random' (assigns pList randomly)
       -- or set an integer (like '1') to hardcode the pList here
       */
  participantCodeMethod: 'randomAndDisplay', /* alternative methods to determine participant ID. Options: 
    * SESSION_ID  // default for prolific prosodylab, more confidential than PID
    * PROLIFIC_PID
    * random 
    * randomAndDisplay // default in prosody for amazon
    PROLIFIC_SESSION_ID and PROLIFIC_PID requires passing urlparams from prolific 
    */    
       
  //
  // Various options settings:
  displayDataAfterFinish: true, // shows collected data in json format after
  showProgressBar: true, // shows progress to participant during study
  fullScreen: false, // doesn't work with IE, but will simply proceed anyway 
  doExperimentOnly: true, // excludes pre-  and post-experiment parts
  //
 };
 

// contact Email in case of problem with urlparameter transmission of participant info
const contactEmail = ''


//  Set basic parameters for the study 

// load messages for interaction with participant:
const messages  = prosodylab.getMessages(study.language);

// Get urlParams if there are any
let urlParams = prosodylab.getURLParameters();

let participantCode = prosodylab.assignParticipantcode(study.participantCodeMethod,urlParams)


//  ---- set-up timeline for experiment ----

let timeline = [];


// Only continue if participantCode is defined
if (!participantCode) { 

  // urlParams weren't properly transmitted, throw error to participant
  timeline.push(prosodylab.screen(`<em>Something didn't work! Contact: ${contactEmail}
      </em>`,'noSessionIdError','Click here to leave experiment','center'));
  } else {
  

  // load spreadsheet with all experiments, global variable
  stimuli = prosodylab.loadCSV(study.stimuliFile);

  // save variable names of study spreadsheet 
  let variables = Object.keys(stimuli[0]);

  // Set name for response file with participant code
  const dataFilename = `data_${participantCode}`;

  // load study log if there is one
  // otherwise an empty log will be written to data folder]
  let studyLog = prosodylab.loadLog(study.logFile);
    
  
  // check for audio recording consent if necessary
  recordVariables = ['record','listenRepeatRecord','plannedProduction'];
  // if any columns imply recording, get audio permission and start media player
  if (recordVariables.some(r=> variables.includes(r))) {
     var blob;
     var audio_chunk;
     var rec = [];
     var soundFileName;
     prosodylab.getAudioConsent();
  } 
  
  //  ---- hello page ----
  
  if (study.doExperimentOnly){
    timeline.push(prosodylab.screenFromMD(study.helloFile,'hello','left'));
  }
  
  // ---- full screen mode if applicable --
  
  if (study.fullScreen) {
    timeline.push(prosodylab.fullScreenOn());
  }
  
  //  ---- consent page  ----
  
  // The last paragraph of the consent  form will be the  consent button
  // and will  be stored with the participant's data:
  if (!study.doExperimentOnly){
     timeline.push(prosodylab.screenFromMD(study.consentFile,'consent','left'));
  }
  
  // ---- language questionnaire ---

  if (!study.doExperimentOnly){
   timeline.push(prosodylab.languageQuestionnaire(study.language));
  }
  
  // ---- sound check (if audio is involved)
  
  if (!study.doExperimentOnly){
    timeline = [...timeline, ...prosodylab.soundCheck(study.soundCheckFile)];
  }
  
  // ---- head phone screener ----
  
  if (!study.doExperimentOnly){
     timeline = [...timeline, ...prosodylab.headPhoneScreener()];
  }
  
  //  
  //  ---- build sessions of experiment trials and add to timeline  ----
  //

  console.log('studyLog',studyLog);
  
  experiment = 
        prosodylab.createSessions(stimuli, study.pListMethod,studyLog,participantCode);
  
  console.log('experiment.timeline',experiment.timeline);
  
  timeline = [...timeline, ...experiment.timeline];
  

  // Post Experiment 
  
  // ---- debriefing ---
  
  if (!study.doExperimentOnly){
    timeline.push(prosodylab.debriefing(study.language));
  }
  // ---- music questionnaire ---
  
  if (!study.doExperimentOnly){
    //timeline.push(prosodylab.musicQuestionnaire('MusicianShip'));
  }
  
  // ----  save data ----
  
  // choose 'csv' as second argument if you want to save  as .csv instead  of json
  timeline.push(prosodylab.saveData(`${study.path}/data/${dataFilename}`,'json'));
  timeline.push(prosodylab.appendJsonCallFunction(experiment.newStudyLogEntries,study.logFile));  
   // exit full screen
  
  if (study.fullScreen) {
    timeline.push({
      type: 'fullscreen',
      fullscreen_mode: false
    });
  }
  
  // ---- goodbye screen (with completion code if applicable )----
  
  if (!study.doExperimentOnly){
    if (study.participantCodeMethod == 'randomAndDisplay') {
      timeline.push(prosodylab.screenFromMD(study.goodbyeFile,'goodBye','center',participantCode));
    } else if (study.completionCode) { 
      //timeline.push(prosodylab.screenFromMD(study.goodbyeFile,'goodBye','center',completionCode));
    } else {
      //timeline.push(prosodylab.screenFromMD(study.goodbyeFile,'goodBye','center'));
    }
  }
  
  
  } 
  
  //  ---- general settings  ----

  jsPsych.init({
      timeline: timeline,
      //// uncomment to save data on close (but closing the tab could mean wihdrawn consent!)
      //on_close:  function(){
      //  prosodylab.saveData(`${study.path}/data/${dataFilename}.json, jsPsych.data.get().json());
      //  prosodylab.saveData(`${study.path}/data/${dataFilename}.csv, jsPsych.data.get().csv());
      //},
      show_progress_bar: study.showProgressBar,
      on_finish: function(){
        if (study.displayDataAfterFinish) {
           // output full data to tab
           jsPsych.data.displayData();
        }
        if (study.completionLink&&participantCode) {
          if (study.completionLink.length>0){
            location.href=study.completionLink
          }
        }
      }
  })

  </script>
</html>
